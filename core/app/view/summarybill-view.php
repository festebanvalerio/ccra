<?php    $fecha = date("d/m/Y");
    if (count($_POST) > 0) {
        $fecha = $_POST["fecha"];
    } else {
        if (isset($_SESSION["com_baja_fecha"])) {
            $fecha = $_SESSION["com_baja_fecha"];
        }
    }
    if ($_SESSION["factel"] == 1) {
        $ruta = $_SERVER["DOCUMENT_ROOT"] . "/";
        require_once ($ruta . "cpeconfig/funciones.php");
    }
    $lstComprobante = ComprobanteData::getAllBill($fecha);
    $lstResumen = ComBajaData::getAll($fecha);
    
    $codigo = "";
    $fechaFactura = date("d/m/Y");
    $objResumenBaja = ComBajaData::getLastId($fechaFactura);
    if ($objResumenBaja) {
        $arrFecha = explode("/", $fechaFactura);
        $fechaBoleta = $arrFecha[2] . "-" . $arrFecha[1] . "-" . $arrFecha[0];
    
        $numero = $objResumenBaja->ultimo_numero + 1;
        $codigo = "RA-" . str_replace("-", "", $fechaBoleta) . "-" . str_pad($numero, 3, "0", STR_PAD_LEFT);
    } else {
        $arrFecha = explode("/", $fechaFactura);
        $fechaBoleta = $arrFecha[2] . "-" . $arrFecha[1] . "-" . $arrFecha[0];
    
        $numero = 1;
        $codigo = "RA-" . str_replace("-", "", $fechaBoleta) . "-" . str_pad($numero, 3, "0", STR_PAD_LEFT);
    }?><script type="text/javascript">	$(function() {		$("#fecha").datepicker({    		dateFormat: "dd/mm/yy",    		changeMonth: true,    		changeYear: true,    		maxDate: "0",    		yearRange: "1900:<?php echo date("Y"); ?>"    	});		});</script><section class="content">	<div class="row">		<div class="col-md-12">			<div class="panel panel-primary">    			<div class="panel-heading" style="background-color: #3c8dbc;"><h3 class="panel-title">Comunicación de Baja</h3></div>            	<div class="panel-body">					<form class="form-horizontal" method="post" id="summarybill" action="" role="form" autocomplete="off">    			            			<div class="form-group">            				<div class="col-md-2 col-sm-12">                				<label for="fecha">Fecha:</label>        						<input type="text" id="fecha" name="fecha" value="<?php echo $fecha; ?>" class="form-control"/>        					</div>        					<div class="col-md-4 col-sm-12" style="padding-top: 25px;">        						<button type="submit" id="btnBuscar" class="btn btn-success" title="Buscar"><em class="fa fa-search"></em></button>        						<?php if (count($lstComprobante) > 0) { ?>        						<button type="button" id="btnGenerar" class="btn btn-info" title="Generar"><em class="fa fa-cloud-upload "></em></button>        						<?php } ?>        						<button type="button" id="btnLimpiar" class="btn btn-danger" title="Limpiar"><em class="fa fa-eraser"></em></button>        						<script type="text/javascript">            						$("#btnLimpiar").click(function(){            							$.blockUI();            							$.post("index.php?action=deletesearch", {                							opcion: "summarybill"                							                                        }, function (data) {                                        	location.href = "./index.php?view=summarybill";                                        });            		    			});            						$("#btnGenerar").click(function(){            							if (confirm("Desea generar el resumen <?php echo $codigo; ?>")) {            								$.post("index.php?action=addsummarybill", {                        						fecha: $("#fecha").val(),                        						accion: "1"                                        	}, function (data) {                                            	alert(data);                                               	window.location.href = "./index.php?view=summarybill";                                            });            							}            		    			});        						</script>            				</div>        				</div>					</form>					<?php if (count($lstResumen) > 0) { ?>					<div class="table-responsive">						<div class="box-body" style="text-align: center; font-weight: bold;">COMUNICACIONES DE BAJA</div>						<div class="box-body">							<table class="table table-bordered table-hover datatable table-nowrap">								<thead>        							<tr>        								<th scope="col">ID</th>        								<th scope="col">Fecha</th>        								<th scope="col">Código</th>        								<th scope="col">Fecha Referencia</th>        								<th scope="col">Detalle</th>        								<th scope="col">Estado SUNAT</th>        								<th scope="col">Fecha de Envío SUNAT</th>        								<th scope="col">Ticket</th>        								<th scope="col">Recepción</th>        								<th scope="col">Estado</th>        								<th scope="col">Acciones</th>        							</tr>        						</thead>        						<tbody>        							<?php        							             							     foreach ($lstResumen as $objResumen) {        							         $lstDetalle = $objResumen->getDetalle();        							                 							         $enviar = $estado = "";        							         if ($objResumen->fe_combaja_estsun == "1") {        							             $estado = "ACEPTADO";        							         } else {        							             if ($objResumen->fe_combaja_estsun == "2") {        							                 $estado = "RECHAZADO";        							             } else {        							                 $enviar = "1";        							                 $estado = "PENDIENTE ENVIO";        							             }        							         }        							         $estado2 = "";        							         if ($objResumen->fe_combaja_faucod2 == "0") {        							             $estado2 = "ACEPTADO";        							         } else {        							             if ($enviar == "") {        							                 $estado2 = "Cod. Error: ".$objResumen->fe_combaja_faucod2;        							             }        							         }        							         $estado3 = "";        							         if ($objResumen->fe_combaja_est == "1") {        							             $estado3 = "REGISTRADO";        							         } else if ($objResumen->fe_combaja_est == "2") {        							             $estado3 = "ELIMINADO";        							         }        							         $fechaEnvioSunat = "";        							         if ($objResumen->fe_combaja_fecenvsun) {        							             $fechaEnvioSunat = date("d-m-Y", strtotime($objResumen->fe_combaja_fecenvsun));        							         }        						    ?>        							<tr>        								<td style="text-align: left;"><?php echo $objResumen->fe_combaja_id; ?></td>        								<td style="text-align: left;"><?php echo date("d/m/Y", strtotime($objResumen->fe_combaja_fec)); ?></td>        								<td style="text-align: left;"><?php echo $objResumen->fe_combaja_cod; ?></td>        								<td style="text-align: left;"><?php echo date("d/m/Y", strtotime($objResumen->fe_combaja_fecref)); ?></td>        								<td style="text-align: left;">        								<?php        								    $fila = 1;        							        foreach ($lstDetalle as $objDetalle) {         									   echo $fila.") ".$objDetalle->fe_combajadetalle_ser."-".$objDetalle->fe_combajadetalle_cor." (".$objDetalle->fe_combajadetalle_mot.")<br/>";                                             }                                        ?>        								</td>        								<td style="text-align: left;"><?php echo $estado; ?></td>        								<td style="text-align: left;"><?php echo $fechaEnvioSunat; ?></td>        								<td style="text-align: left;"><?php echo $objResumen->fe_combaja_tic; ?></td>        								<td style="text-align: left;"><?php echo $estado2; ?></td>        								<td style="text-align: left;"><?php echo $estado3; ?></td>        								<td style="text-align: center;">        									<?php if ($objResumen->fe_combaja_est == "2") { ?>        									<?php if ($enviar == "1") {?>        									<a id="lnkenv<?php echo $objResumen->fe_combaja_id; ?>" title="Enviar a SUNAT" class="btn btn-info btn-xs">ES</a>        									<script type="text/javascript">                        						$("#lnkenv<?php echo $objResumen->fe_combaja_id; ?>").click(function() {                        							if (confirm("Desea enviar el resumen <?php echo $objResumen->fe_combaja_cod; ?>")) {                        								$.post("index.php?action=addsummarybill", {                        									id: <?php echo $objResumen->fe_combaja_id; ?>,                        									codigo: "<?php echo $objResumen->fe_combaja_cod; ?>",                                        					item: "<?php echo count($lstDetalle); ?>",                                							accion: "3"                                                        }, function (data) {                                                        	if (data !== "") {                                                            	alert(data);                                                            	window.location.href = "./index.php?view=summarybill";                                                        	} else {                                                        		alert("Ocurrio un error, comunicarse con el administrador");                                                                return false;                                                        	}                                                        });                            						}                        						});                        					</script>        									        									<?php } ?>        									<a id="lnkdel<?php echo $objResumen->fe_combaja_id; ?>" title="Eliminar" class="btn btn-danger btn-xs"><em class="fa fa-trash"></em></a>        									<script type="text/javascript">                        						$("#lnkdel<?php echo $objResumen->fe_combaja_id; ?>").click(function() {                            						if (confirm("Desea eliminar el resumen <?php echo $objResumen->fe_combaja_cod; ?>")) {                        								$.post("index.php?action=addsummarybill", {                        									id: <?php echo $objResumen->fe_combaja_id; ?>,                                							accion: "2"                                                        }, function (data) {                                                        	if (data !== "") {                                                            	alert(data);                                                            	window.location.href = "./index.php?view=summarybill";                                                        	} else {                                                        		alert("Ocurrio un error, comunicarse con el administrador");                                                                return false;                                                        	}                                                        });                            						}                        						});                        					</script>                        					<?php } ?>        								</td>        							</tr>        							<?php } ?>        						</tbody>        					</table>        				</div>        			</div>        			<div><br/></div>        			<?php } ?>
					<div class="table-responsive">						<div class="box-body" style="text-align: center; font-weight: bold;">COMPROBANTES ELECTRÓNICOS ANULADOS</div>						<div class="box-body">							<table class="table table-bordered table-hover datatable table-nowrap">								<thead>        							<tr>        								<th scope="col">Comprobante</th>        								<th scope="col">Nro Documento</th>        								<th scope="col">RUC</th>        								<th scope="col">Cliente</th>            							<th scope="col">Importe Total</th>            							<th scope="col">Fecha de Emisión</th>            							<th scope="col">Estado</th>            							<th scope="col">Estado SUNAT</th>            							<th scope="col">Fecha Envío SUNAT</th>            							<th scope="col">Detalle</th>        							</tr>        						</thead>
        						<?php        						    foreach ($lstComprobante as $objComprobante) {
                                        $indicadorDetalle = $estadoSunat = $fechaSunat ="";                                        if ($_SESSION["factel"] == 1) {                                            $data_sunat = estado_sunat($objComprobante->fe_comprobante_estsun,$objComprobante->fe_comprobante_resbol,$objComprobante->fe_comprobante_combaj);                                            $estadoSunat = $data_sunat["estado_sunat"];                                                                                        $fechaSunat = date("d/m/Y H:i", strtotime($objComprobante->fe_comprobante_fecenvsun));                                                                                        $lstComBajaDetalle = ComBajaDetalleData::getDetalle($objComprobante->fe_comprobante_id);                                            if (count($lstComBajaDetalle) == 0) {                                                $indicadorDetalle = "PENDIENTE";                                                                                                } else {                                                $indicadorDetalle = "DECLARADO";                                            }                                        }                                        $nomEstado = $estado = "";                                        if ($objComprobante->fe_comprobante_est != 1) {                                            $estado = "color: red;";                                            $nomEstado = "ANULADO";                                        } else {                                            $nomEstado = "REGISTRADO";                                        }
                                ?>
        							<tr>        								<td style="text-align: left;"><?php echo "FACTURA"; ?></td>        								<td style="text-align: left;"><?php echo $objComprobante->fe_comprobante_ser."-".$objComprobante->fe_comprobante_cor; ?></td>        								<td style="text-align: left;"><?php echo $objComprobante->tb_cliente_numdoc; ?></td>        								<td style="text-align: left;"><?php echo $objComprobante->tb_cliente_nom; ?></td>        								<td style="text-align: right;"><?php echo number_format($objComprobante->fe_comprobante_imptot, 2); ?></td>        								<td style="text-align: right;"><?php echo date("d/m/Y", strtotime($objComprobante->fe_comprobante_fec)); ?></td>        								<td style="text-align: left; <?php echo $estado; ?>"><?php echo $nomEstado; ?></td>        								<td style="text-align: left;"><?php echo $estadoSunat; ?></td>        								<td style="text-align: right;"><?php echo $fechaSunat; ?></td>        								<td style="text-align: left;"><?php echo $indicadorDetalle; ?></td>        							</tr>
        						<?php                                    }
        			             ?>
        					</table>						</div>					</div>				</div>			</div>		</div>				</div></section>