<?php    $fecha = date("d/m/Y");    if (count($_POST) > 0) {        $fecha = $_POST["fecha"];                   } else {        if (isset($_SESSION["resumen_boleta_fecha"])) {            $fecha = $_SESSION["resumen_boleta_fecha"];        }    }        if ($_SESSION["factel"] == 1) {        $ruta = $_SERVER["DOCUMENT_ROOT"]."/";        require_once($ruta."cpeconfig/funciones.php");        require_once($ruta."cpeconfig/funciones.php");    }    $ruc = "";    if (isset($_SESSION["ruc"])) {        $ruc = $_SESSION["ruc"];    }    $lstComprobante = ComprobanteData::getAllSummary($fecha);    $lstResumen = ResumenBoletaData::getAll($fecha);        $codigo = "";    $fechaBoleta = date("d/m/Y");        $objResumenBoleta = ResumenBoletaData::getLastId($fechaBoleta);    if ($objResumenBoleta) {        $arrFecha = explode("/", $fechaBoleta);        $fechaBoleta = $arrFecha[2] . "-" . $arrFecha[1] . "-" . $arrFecha[0];                $numero = $objResumenBoleta->ultimo_numero + 1;                $codigo = "RC-".str_replace("-", "", $fechaBoleta)."-".str_pad($numero, 3, "0", STR_PAD_LEFT);    } else {        $arrFecha = explode("/", $fechaBoleta);        $fechaBoleta = $arrFecha[2] . "-" . $arrFecha[1] . "-" . $arrFecha[0];                $numero = 1;        $codigo = "RC-".str_replace("-", "", $fechaBoleta)."-".str_pad($numero, 3, "0", STR_PAD_LEFT);    }?><script type="text/javascript">	$(function() {		$("#fecha").datepicker({    		dateFormat: "dd/mm/yy",    		changeMonth: true,    		changeYear: true,    		maxDate: "0",    		yearRange: "1900:<?php echo date("Y"); ?>"    	});		});</script><section class="content">	<div class="row">		<div class="col-md-12">			<div class="panel panel-primary">    			<div class="panel-heading" style="background-color: #3c8dbc;"><h3 class="panel-title">Resumen Diario de Boletas</h3></div>            	<div class="panel-body">					<form class="form-horizontal" method="post" id="summaryticket" action="" role="form" autocomplete="off">    			            			<div class="form-group">            				<div class="col-md-2 col-sm-12">                				<label for="fecha">Fecha:</label>        						<input type="text" id="fecha" name="fecha" value="<?php echo $fecha; ?>" class="form-control" readonly/>        					</div>        					<div class="col-md-10 col-sm-12" style="padding-top: 25px;">        						<button type="button" id="btnBuscar" class="btn btn-success" title="Buscar"><em class="fa fa-search"></em></button>        						<?php if (count($lstComprobante) > 0) { ?>        						<button type="button" id="btnGenerar" class="btn btn-info" title="Generar"><em class="fa fa-cloud-upload "></em></button>        						<?php } ?>        						<button type="button" id="btnLimpiar" class="btn btn-danger" title="Limpiar"><em class="fa fa-eraser"></em></button>        						<script type="text/javascript">        							$("#btnBuscar").click(function(){            							$.blockUI();            		    				$("button").prop("disabled", true);            		    				$("#summaryticket").submit();            		    			});            						$("#btnLimpiar").click(function(){            							$.blockUI();            							$("button").prop("disabled", true);            							$.post("index.php?action=deletesearch", {                							opcion: "summaryticket"                							                                        }, function (data) {                                        	location.href = "./index.php?view=summaryticket";                                        });            		    			});            						$("#btnGenerar").click(function(){            							if (confirm("Desea generar el resumen <?php echo $codigo; ?>")) {            								$.blockUI();            								$("button").prop("disabled", true);            								$.post("index.php?action=addsummaryticket", {                        						fecha: $("#fecha").val(),                        						accion: "1"                                        	}, function (data) {                                            	alert(data);                                               	window.location.href = "./index.php?view=summaryticket";                                            });            							}            		    			});        						</script>            				</div>        				</div>					</form>					<?php if (count($lstResumen) > 0) { ?>					<div class="table-responsive">						<div class="box-body" style="text-align: center; font-weight: bold;">RESUMEN</div>						<div class="box-body">							<table class="table table-bordered table-hover datatable table-nowrap">								<thead>        							<tr>        								<th scope="col">ID</th>        								<th scope="col">Fecha</th>        								<th scope="col">Código</th>        								<th scope="col">Fecha Referencia</th>        								<th scope="col">Detalle</th>        								<th scope="col">Estado SUNAT</th>        								<th scope="col">Fecha de Envío SUNAT</th>        								<th scope="col">Ticket</th>        								<th scope="col">Recepción</th>        								<th scope="col">Estado</th>        								<th scope="col">Acciones</th>        							</tr>        						</thead>        						<tbody>        							<?php        							     foreach ($lstResumen as $objResumen) {        							         $lstDetalle = $objResumen->getDetalle();        							                 							         $xml = $cdr = "";        							         $enviar = $estado = "";        							         if ($objResumen->fe_resumenboleta_estsun == "1") {        							             $estado = "ACEPTADO";        							         } else {        							             if ($objResumen->fe_resumenboleta_estsun == "2") {        							                 $estado = "RECHAZADO";        							             } else {        							                 $enviar = "1";        							                 $estado = "PENDIENTE ENVIO";        							             }        							         }        							         $estado2 = "";        							         if ($objResumen->fe_resumenboleta_faucod2 == "0") {        							             $estado2 = "ACEPTADO";        							                     							             $xml = $ruc . "-". $objResumen->fe_resumenboleta_cod;        							             $cdr = "R-" . $ruc . "-". $objResumen->fe_resumenboleta_cod;        							         } else {        							             if ($enviar == "") {        							                 $estado2 = "Cod. Error: ".$objResumen->fe_resumenboleta_faucod2;        							             }        							         }        							                 							         $estado3 = "";        							         if ($objResumen->fe_resumenboleta_est == "1") {        							             $estado3 = "REGISTRADO";        							         } else if ($objResumen->fe_resumenboleta_est == "2") {        							             $estado3 = "ELIMINADO";        							         }        							         $fechaEnvioSunat = "";        							         if ($objResumen->fe_resumenboleta_fecenvsun) {        							             $fechaEnvioSunat = date("d-m-Y H:i:s", strtotime($objResumen->fe_resumenboleta_fecenvsun));        							         }        						    ?>        							<tr>        								<td style="text-align: left;"><?php echo $objResumen->fe_resumenboleta_id; ?></td>        								<td style="text-align: left;"><?php echo date("d/m/Y", strtotime($objResumen->fe_resumenboleta_fec)); ?></td>        								<td style="text-align: left;"><?php echo $objResumen->fe_resumenboleta_cod; ?></td>        								<td style="text-align: left;"><?php echo date("d/m/Y", strtotime($objResumen->fe_resumenboleta_fecref)); ?></td>        								<td style="text-align: left;"><?php echo count($lstDetalle)." COMPROBANTES"; ?></td>        								<td style="text-align: left;"><?php echo $estado; ?></td>        								<td style="text-align: left;"><?php echo $fechaEnvioSunat; ?></td>        								<td style="text-align: left;"><?php echo $objResumen->fe_resumenboleta_tic; ?></td>        								<td style="text-align: left;"><?php echo $estado2; ?></td>        								<td style="text-align: left;"><?php echo $estado3; ?></td>        								<td style="text-align: center;">        									<?php if ($objResumen->fe_resumenboleta_est == "2") { ?>        									<?php if ($enviar == "1") { ?>        									<a id="lnkenv<?php echo $objResumen->fe_resumenboleta_id; ?>" title="Enviar a SUNAT" class="btn btn-info btn-xs">ES</a>        									<script type="text/javascript">                        						$("#lnkenv<?php echo $objResumen->fe_resumenboleta_id; ?>").click(function() {                            						if (confirm("Desea enviar el resumen <?php echo $objResumen->fe_resumenboleta_cod; ?> a la SUNAT")) {                        								$.post("index.php?action=addsummaryticket", {                        									id: <?php echo $objResumen->fe_resumenboleta_id; ?>,                                							codigo: "<?php echo $objResumen->fe_resumenboleta_cod; ?>",                                							item: <?php echo count($lstDetalle); ?>,                                							accion: "3"                                                        }, function (data) {                                                        	if (data !== "") {                                                            	alert(data);                                                            	window.location.href = "./index.php?view=summaryticket";                                                        	} else {                                                        		alert("Ocurrio un error, comunicarse con el administrador");                                                                return false;                                                        	}                                                        });                            						}                        						});                        					</script>        									<?php } ?>        									<a id="lnkdel<?php echo $objResumen->fe_resumenboleta_id; ?>" title="Eliminar" class="btn btn-danger btn-xs"><em class="fa fa-trash"></em></a>        									<script type="text/javascript">                        						$("#lnkdel<?php echo $objResumen->fe_resumenboleta_id; ?>").click(function() {                            						if (confirm("Desea eliminar el resumen <?php echo $objResumen->fe_resumenboleta_cod; ?>")) {                        								$.post("index.php?action=addsummaryticket", {                        									id: <?php echo $objResumen->fe_resumenboleta_id; ?>,                                							accion: "2"                                                        }, function (data) {                                                        	if (data !== "") {                                                            	alert(data);                                                            	window.location.href = "./index.php?view=summaryticket";                                                        	} else {                                                        		alert("Ocurrio un error, comunicarse con el administrador");                                                                return false;                                                        	}                                                        });                            						}                        						});                        					</script>                        					<?php } else if ($estado2 != "") { ?>                        					<a href="../../cperepositorio/send/<?php echo $xml; ?>.zip" title="Descargar XML" class="btn btn-success btn-xs" target="_blank"><em class="fa fa-cloud-download"></em></a>                        					<a href="../../cperepositorio/cdr/<?php echo $cdr; ?>.zip" title="Descargar CDR" class="btn btn-primary btn-xs" target="_blank"><em class="fa fa-cloud-download"></em></a>                        					<?php } ?>        								</td>        							</tr>        							<?php } ?>        						</tbody>        					</table>        				</div>        			</div>        			<div><br/></div>        			<?php } ?>
					<div class="table-responsive">						<div class="box-body" style="text-align: center; font-weight: bold;">COMPROBANTES ELECTRÓNICOS</div>						<div class="box-body">							<table class="table table-bordered table-hover datatable table-nowrap">								<thead>        							<tr>        								<th scope="col">Item</th>        								<th scope="col">Comprobante</th>        								<th scope="col">Nro Documento</th>        								<th scope="col">DNI</th>        								<th scope="col">Cliente</th>            							<th scope="col">Op. Gravadas</th>            							<th scope="col">Op. Inafectas</th>            							<th scope="col">Op. Exoneradas</th>            							<th scope="col">IGV</th>            							<th scope="col">Total</th>            							<th scope="col">Estado</th>            							<th scope="col">Detalle</th>        							</tr>        						</thead>
        						<?php        						    $item = 1;
                                    foreach ($lstComprobante as $objComprobante) {
                                        $indicadorDetalle = $estadoDetalle = "";                                        if ($_SESSION["factel"] == 1) {                                            $lstResumenBoletaDetalle = ResumenBoletaDetalleData::getDetalle($objComprobante->fe_comprobante_id);                                            if (count($lstResumenBoletaDetalle) == 0) {                                                $indicadorDetalle = "ADICIONAR";                                                $estadoDetalle = "color: green;";                                            } else if (count($lstResumenBoletaDetalle) == 1) {                                                if ($objComprobante->fe_comprobante_est == 1) {                                                    $indicadorDetalle = "DECLARADO";                                                                                                        } else if ($objComprobante->fe_comprobante_est == 2) {                                                    $indicadorDetalle = "ADICIONAR (A)";                                                    $estadoDetalle = "color: blue;";                                                }                                            } else  if (count($lstResumenBoletaDetalle) == 2) {                                                $indicadorDetalle = "DECLARADO";                                            }                                        }                                        $nomEstado = $estado = "";                                        if ($objComprobante->fe_comprobante_est != 1) {                                            $estado = "color: red;";                                            $nomEstado = "ANULADO";                                        } else {                                            $nomEstado = "REGISTRADO";                                        }
                                ?>
        							<tr>        								<td style="text-align: left;"><?php echo $item++; ?></td>        								<td style="text-align: left;"><?php echo "BOLETA"; ?></td>        								<td style="text-align: left;"><?php echo $objComprobante->fe_comprobante_ser."-".$objComprobante->fe_comprobante_cor; ?></td>        								<td style="text-align: left;"><?php echo $objComprobante->tb_cliente_numdoc; ?></td>        								<td style="text-align: left;"><?php echo $objComprobante->tb_cliente_nom; ?></td>        								<td style="text-align: right;"><?php echo number_format($objComprobante->fe_comprobante_totvengra, 2); ?></td>        								<td style="text-align: right;"><?php echo number_format($objComprobante->fe_comprobante_totvenina, 2); ?></td>        								<td style="text-align: right;"><?php echo number_format($objComprobante->fe_comprobante_totvenexo, 2); ?></td>        								<td style="text-align: right;"><?php echo number_format($objComprobante->fe_comprobante_sumigv, 2); ?></td>        								<td style="text-align: right;"><?php echo number_format($objComprobante->fe_comprobante_imptot, 2); ?></td>        								<td style="text-align: left; <?php echo $estado; ?>"><?php echo $nomEstado; ?></td>        								<td style="text-align: left; <?php echo $estadoDetalle; ?>"><?php echo $indicadorDetalle; ?></td>        							</tr>
        						<?php                                    }
        			             ?>
        					</table>						</div>					</div>				</div>			</div>		</div>				</div></section>